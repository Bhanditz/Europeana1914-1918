<%

	@javascripts[:images_loaded] = true
	@javascripts[:carousel] = true
	@javascripts[:lightbox] = true
	@javascripts[:truncate] = true
	@javascripts[:translate] = true
	@javascripts[:edm_object_page] = true
	@javascripts[:shares] = true

	@stylesheets[:item] = true

	if record['aggregations'].first['edmProvider'].blank? ||
		( !record['aggregations'].first['edmProvider'].values.include?("Europeana 1914 - 1918") )

		aggregation     = record['aggregations'] ? record['aggregations'][0] : {}
		carouselImages  = aggregation['hasView'] || []
		carouselImages.unshift(aggregation['edmIsShownBy']) unless aggregation['edmIsShownBy'].blank?
		carouselImages  = paginate_array(carouselImages, params[:page] || 1, 3)
		euAggregation   = record['europeanaAggregation']
		edmIsShownAt    = aggregation['edmIsShownAt'] ? aggregation['edmIsShownAt'] : nil
		edmIsShownBy    = aggregation['edmIsShownBy'] ? aggregation['edmIsShownBy'] : nil
		edmPreview      = euAggregation['edmPreview'] ? euAggregation['edmPreview'] : '/images/style/icons/mimetypes/unknown.png'
		edmProvider     = aggregation['edmProvider'] ? aggregation['edmProvider'] : nil
		type            = record['type'] ? record['type'] : nil
		html            = ''
		oembed          = oembed_fields( record )
		places          = record['places'] ? record['places'] : {}
		proxy           = record['proxies'][0]
		title           = proxy ? edm_proxy_field(proxy, 'dcTitle') : 'unknown'

		link_image      = '<img src="' + edmPreview + '" alt="' + title + '"/>'
		link_record     = record['about'] ? europeana_record_url( record['about'] ) : nil
		link_text_image = ''
		link_text_video = '<p class="view-item">' + t( 'common.links.play-video' ) + '</p>'

		link_attrs      = {
										'class' => 'image',
										'data-description' => title,
										:rel => 'prettyPhoto[gallery]',
										:title => title
		}

		if type == 'TEXT'
			link_attrs.merge!({
				'data-record' => link_record
			})
		end

		if edmProvider && edmProvider['def'] && edmProvider['def'][0]
			edmProvider = edmProvider['def'][0]
		end

		if !(
			params[:controller] == 'federated_search/dpla' ||
		 	params[:controller] == 'federated_search/trove' ||
		  params[:controller] == 'federated_search/digitalnz'
		)
			link_text_image = '<p class="view-item">' + t( 'common.links.view-image' ) + '</p>'
		end

		if referred_by_search?
		  html += '<div class="back-link-row hide-on-item-collapsed">'
				html += back_to_search_link
  		html += '</div>'
		end

		html += '<div class="container">'

			html += '<div class="col left">'

				html += '<div class="col-cell show-on-item-collapsed">'
					html += '<h2 class="dcTitle"> ' + edm_proxy_field(proxy, 'dcTitle') + '</h2>'
				html += '</div>'

				html += '<div class="col-cell">'

					html += '<div class="img-panel">'
						html += '<div id="institution-featured" class="carousel">'
							html += '<ul>'

							# multiple images
							if carouselImages.present?

								developer_content = '<!--carousel images-->'
								carousel_count = 0

								carouselImages.each do |img_src|

									link_image = '<img src="' + img_src + '" alt="' + title + '"/>'
									link_content = link_image + link_text_image
									carousel_count += 1
									html += '<li>' + link_to( link_content.html_safe, img_src, link_attrs ) + developer_content + '</li>'

									if carousel_count == 3
										break
									end
								end

							# single image
							else

								# view at provider’s website
								if edmIsShownAt &&
									(
									  params[:controller] == 'federated_search/dpla' ||
									  params[:controller] == 'federated_search/trove' ||
									  params[:controller] == 'federated_search/digitalnz'
									)

									# link available at provider’s website
									if readVal = edm_proxy_field(aggregation, 'edmIsShownAt')

										developer_content = '<!--view on provider’s site-->'
										link_content = link_image + link_text_image

										link_attrs.merge!({
											:class => 'original-context',
											:target => '_blank',
											:rel => nil
										})

										html += '<li>' + link_to( link_content.html_safe, readVal, link_attrs ) + developer_content + '</li>'

									# do not view on provider’s website
									else

										developer_content = '<!--do not view on provider’s site-->'
										html += '<li>' + link_image.html_safe + developer_content + '</li>'

									end

								# view on 1914-1918 website - show the edmIsShownBy in the lightbox
								elsif edmIsShownBy

									dimensions = '&width=100%&height=100%'
									video_src = link_record + '?edmvideo=true&iframe=true'

									# edmIsShownBy will be a direct link to a vimeo video
									if /player.vimeo.com/.match( edmIsShownBy )

										video_src = edmIsShownBy + '?iframe=true' + dimensions

									# edmIsShownBy has several possible values
									# eventhough the iframe dimensions are 640 x 480,
									# because of the lightbox ui the dimensions need to be wider and higher
									elsif /EFG - The European Film Gateway/.match( edmProvider )

										if /api.picturepipe.net/.match( edmIsShownBy )
											dimensions = '&width=657&height=510'
										end

									end

									video_src = video_src + dimensions
									link_content = link_image + link_text_image
									developer_content = '<!--edmIsShownBy in lightbox-->'

									if oembed
										developer_content += '<!--oembeded content-->'
									end

									html += '<li>' + link_to( link_content.html_safe, video_src, link_attrs ) + developer_content + '</li>'

								# view on 1914-1918 website - show the edmPreview, no lightbox
								else

									link_content = link_image
									developer_content = '<!--edmPreview only, no lightbox-->'
									html += '<li>' + link_content.html_safe + developer_content + '</li>'
									#html += '<li>' + link_to( link_content.html_safe, edmPreview, link_attrs ) + developer_content + '</li>'

								end

							end

							html += '</ul>'
							html += '<div class="carousel-overlay"></div>'
						html += '</div>'
						html += '</div>'
					# 	ticket 195 - "remove the title"
					#html += '<p class="subtitle">' + title + '</p>'
				html += '</div>'

				# add pagination info if present
				if carouselImages.present? && carouselImages.size > 1
					html += '<div id="carousel-pagination">' + will_paginate( carouselImages ) + 'Total: <span id="pagination-total">' + carouselImages.total_entries.to_s + '</span></div>'
					html += '<div class="col-cell"><ul id="pagination-counts"></ul></div>'
				end

				# add view at provider’s website text link
				if edmIsShownAt

					if(
						  params[:controller] == 'federated_search/dpla'  ||
						  params[:controller] == 'federated_search/trove' ||
						  params[:controller] == 'federated_search/digitalnz'
					)
						html += '<div class="col-cell">'
					    	html += '<span class="icon-external"></span>'
							html += '<div class="external-link">'
								html += '<a href="' + edmIsShownAt + '" target="_blank">'
								html += t('formtastic.labels.content.metadata.edm.external_partner_site')

 								html += '</a>'
							html += '</div>'
						html += '</div>'

					elsif readLabel = edm_proxy_field(aggregation, 'edmDataProvider')
						html += '<div class="col-cell">'
					    	html += '<span class="icon-external"></span>'
							html += '<div class="external-link">'
								html += t('formtastic.labels.content.metadata.edm.partner_site') + '<a href="' + edmIsShownAt + '" target="_blank">' + ': ' + readLabel + '</a>'
							html += '</div>'
						html += '</div>'
					end
				end

				html += '<div class="col-cell">'
			    	html += '<span class="icon-share">' + t('views.contributions.show.headings.share') + '</span>'
 					html += render :partial => '/layouts/navigation/sharethis'
 				html += '</div>'

				html += '<div class="col-cell translate-area" >'
			    	html += '<span class="icon-translate"></span>'
 				html += '</div>'

			html += '</div>'

			html += '<div class="col middle metadata">'
				html += '<div id="story-metadata" class="col middle metadata">'
					html += '<h2 class="dcTitle hide-on-item-collapsed"> ' + edm_proxy_field(proxy, 'dcTitle') + '</h2>'
					html += '<div class="col-cell">'
						html +=	render :partial => '/metadata/display_edm',
							:locals => {
								:proxy => proxy,
								:aggregation => aggregation,
								:euAggregation => euAggregation,
								:record => record
							}
					html += '</div>'


					if latLong = edm_places_latlng(record['places'])
						html += '<div class="col-cell">'
							html += '<div id="map-container">'
								html += '<div id="map"></div>'
								if latLong
									html += "<script>var latLong = [" + latLong + "];</script>"

								end
							html += '</div>'
						html += '</div>'
					end


				html += '</div>'
			html += '</div>'
		html += '</div>'
	end
-%>
<%= html.html_safe -%>
