<%

	@javascripts[:images_loaded] = true
	@javascripts[:carousel] = true
	@javascripts[:lightbox] = true
	@javascripts[:truncate] = true
	@javascripts[:translate] = true
	@javascripts[:edm_object_page] = true

	@stylesheets[:item] = true

	if record['aggregations'].first['edmProvider'].blank? ||
		( record['aggregations'].first['edmProvider']['def'].first != "Europeana 1914 - 1918" )

		proxy          = record['proxies'][0]
		places         = record['places'] ? record['places'] : {}
		aggregation    = record['aggregations'] ? record['aggregations'][0] : {}
		euAggregation  = record['europeanaAggregation']
		edmPreview     = euAggregation['edmPreview'] ? euAggregation['edmPreview'] : '/images/style/icons/mimetypes/unknown.png'
		edmIsShownAt   = aggregation['edmIsShownAt'] ? aggregation['edmIsShownAt'] : nil
		edmIsShownBy   = aggregation['edmIsShownBy'] ? aggregation['edmIsShownBy'] : edmPreview
		carouselImages = aggregation['hasView']

		title          = proxy ? edm_proxy_field(proxy, 'dcTitle') : 'unknown'
		oembed         = oembed_fields( record )
		link_attrs     = {
										:title => title,
										'class' => 'image',
										'data-description' => title,
										:rel => 'prettyPhoto[gallery]'
		}

		link_image = '<img src="' + edmPreview + '" alt="' + title + '"/>'
		link_text_image = '<p class="view-item">' + t( 'common.links.view-image' ) + '</p>'
		link_text_video = '<p class="view-item">' + t( 'common.links.play-video' ) + '</p>'

		html = '<div class="container">'

			html += '<div class="col left">'
				if referred_by_search?
					html += '<div class="col-cell hide-on-item-collapsed">'
						html += link_to t('views.links.back-to-search'), :back
					html += '</div>'
				end

				html += '<div class="col-cell">'

					html += '<div class="img-panel">'
						html += '<div id="institution-featured" class="carousel">'
							html += '<ul>'

							# oembeded item
							if oembed

								if oembed['provider_name'] == 'Vimeo'
									video_src = '//player.vimeo.com/video/' + oembed['video_id'].to_s + '?iframe=true&width=100%&height=100%'
								else
									video_src = edmPreview
								end

								link_content = link_image + link_text_video
								html += '<li>' + link_to( link_content.html_safe, video_src, link_attrs ) + '</li>'

							# multiple images
							elsif carouselImages

								carouselImages.each do |img_src|
									link_image = '<img src="' + img_src + '" alt="' + title + '"/>'
									link_content = link_image + link_text_image
									html += '<li>' + link_to( link_content.html_safe, img_src, link_attrs ) + '</li>'
								end

							# single image
							else

								# view at provider’s website
								if edmIsShownAt &&
									(
									  params[:controller] == 'federated_search/dpla' ||
									  params[:controller] == 'federated_search/trove' ||
									  params[:controller] == 'federated_search/digitalnz'
									)

									html += '<script type="text/javascript"> window.blockLightbox = true; </script>'

									# link available at provider’s website
									if readVal = edm_proxy_field(aggregation, 'edmIsShownAt')

										link_content = link_image + link_text_image
										link_attrs.merge!({
											:class => 'original-context',
											:target => '_blank'
										})

										html += '<li>' + link_to( link_content.html_safe, readVal, link_attrs ) + '</li>'

									# link not available at provider’s website
									else

										html += '<li>' + link_image.html_safe + '</li>'

									end

								# view on 1914-1918 website
								else

									link_content = link_image + link_text_image
									html += '<li>' + link_to( link_content.html_safe, edmIsShownBy, link_attrs ) + '</li>'

								end

							end

							html += '</ul>'
						html += '<div class="carousel-overlay"></div>'
					html += '</div>'
				html += '</div>'
				html += '<p class="subtitle">' + title + '</p>'
			html += '</div>'

		html += render :partial => '/layouts/navigation/sharethis'

		if latLong = edm_places_latlng(record['places'])

			html += '<div id="story-metadata" class="col middle metadata show-on-item-collapsed">'
				html += '<div class="col-cell">'
					html += render :partial => '/metadata/display_edm',
							:locals => {
								:proxy => proxy,
								:aggregation => aggregation,
								:euAggregation => euAggregation,
								:record => record
							}

				html += '</div>'
			html += '</div>'

			html += '<div class="col-cell">'
				html += '<div id="map-container">'
					html += '<div id="map"></div>'
					if latLong
						html += "<script>var latLong = [" + latLong + ".split(',')];</script>"
					end
				html += '</div>'
			html += '</div>'
		end

		html += '</div>'

		html += '<div id="story-metadata" class="col middle metadata hide-on-item-collapsed">'
			html += '<h2 class="dcTitle"> ' + edm_proxy_field(proxy, 'dcTitle') + '</h2>'
			html += '<div class="col-cell">'
				html +=	render :partial => '/metadata/display_edm',
					:locals => {
						:proxy => proxy,
						:aggregation => aggregation,
						:euAggregation => euAggregation,
						:record => record
					}
			html += '</div>'

			if readVal = edm_proxy_field(aggregation, 'edmIsShownAt')
				html += '<div class="col-cell">'
					html += '<a href="' + readVal + '" target="_new">' + t('formtastic.labels.content.metadata.edm.partner_site') + '</a>'
				html += '</div>'
			end
		html += '</div>'
	html += '</div>'
	end
-%>
<%= html.html_safe %>
